<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE extension SYSTEM "ext-1.0.dtd">

<extension engine="1.0">
<id>disable_signature_for_group</id>
<title>Disable signature for group</title>
<description>Добавляет возможность отключения подписи для группы. Disable signature for group</description>
<author>floop</author>
<version>0.1</version>
<minversion>1.4RC2</minversion>
<maxtestedon>1.4RC2</maxtestedon>
  
<install><![CDATA[
	$forum_db->add_field('groups', 'g_disable_signature', 'TINYINT(1)', false, 0);
]]></install>
	
<uninstall><![CDATA[
	$forum_db->drop_field('groups', 'g_disable_signature');
]]></uninstall>
  
  
<hooks>

<hook id="vt_qr_get_posts"><![CDATA[
	$query = array(
		'SELECT'	=> 'u.email, u.title, u.url, u.location, u.signature, u.email_setting, u.num_posts, u.registered, u.admin_note, u.avatar, u.avatar_width, u.avatar_height, p.id, p.poster AS username, p.poster_id, p.poster_ip, p.poster_email, p.message, p.hide_smilies, p.posted, p.edited, p.edited_by, g.g_id, g.g_disable_signature AS disable_signature, g.g_user_title, o.user_id AS is_online',
		'FROM'		=> 'posts AS p',
		'JOINS'		=> array(
			array(
				'INNER JOIN'	=> 'users AS u',
				'ON'			=> 'u.id=p.poster_id'
			),
			array(
				'INNER JOIN'	=> 'groups AS g',
				'ON'			=> 'g.g_id=u.group_id'
			),
			array(
				'LEFT JOIN'		=> 'online AS o',
				'ON'			=> '(o.user_id=u.id AND o.user_id!=1 AND o.idle=0)'
			),
		),
		'WHERE'		=> 'p.id IN ('.implode(',', $posts_id).')',
		'ORDER BY'	=> 'p.id'
	);
]]></hook>

<hook id="pf_qr_get_user_info"><![CDATA[
	$query = array(
		'SELECT'	=> 'u.*, g.g_id, g.g_user_title, g.g_moderator, g.g_disable_signature AS disable_signature',
		'FROM'		=> 'users AS u',
		'JOINS'		=> array(
			array(
				'LEFT JOIN'	=> 'groups AS g',
				'ON'		=> 'g.g_id=u.group_id'
			)
		),
		'WHERE'		=> 'u.id='.$id
	);
]]></hook>

<hook id="pf_new_action"><![CDATA[
	if ($user['disable_signature'] == '1') $forum_config['o_signatures'] = '0';
]]></hook>

<hook id="vt_post_loop_start"><![CDATA[
	if ($cur_post['disable_signature'] == 1) $cur_post['signature'] = '';
]]></hook>

<hook id="agr_add_edit_end_validation"><![CDATA[
	$disable_signature = isset($_POST['disable_signature']) ? intval($_POST['disable_signature']) : '0';
]]></hook>

<hook id="agr_add_edit_group_pre_user_permissions_fieldset_end"><![CDATA[?>
	<div class="mf-item">
		<span class="fld-input"><input type="checkbox" id="fld<?php echo ++$forum_page['fld_count'] ?>" name="disable_signature" value="1"<?php if ($group['g_disable_signature'] == '1') echo ' checked="checked"' ?> /></span>
		<label for="fld<?php echo $forum_page['fld_count'] ?>"><?php echo 'Disable signature' ?></label>
	</div>
<?php]]></hook>
	
<hook id="pf_change_details_signature_validation"><![CDATA[?>
	if ($forum_config['o_signatures'] == '0' || $user['disable_signature'] == '1') message($lang_profile['Signatures disabled']);
<?php]]></hook>
		
<hook id="agr_edit_end_qr_update_group"><![CDATA[
	$query = array(
		'UPDATE'	=> 'groups',
		'SET'		=> 'g_title=\''.$forum_db->escape($title).'\', g_user_title='.$user_title.', g_moderator='.$moderator.', g_mod_edit_users='.$mod_edit_users.', g_mod_rename_users='.$mod_rename_users.', g_mod_change_passwords='.$mod_change_passwords.', g_mod_ban_users='.$mod_ban_users.', g_read_board='.$read_board.', g_view_users='.$view_users.', g_post_replies='.$post_replies.', g_post_topics='.$post_topics.', g_edit_posts='.$edit_posts.', g_delete_posts='.$delete_posts.', g_delete_topics='.$delete_topics.', g_set_title='.$set_title.', g_search='.$search.', g_search_users='.$search_users.', g_send_email='.$send_email.', g_post_flood='.$post_flood.', g_search_flood='.$search_flood.', g_email_flood='.$email_flood.', g_disable_signature='.$disable_signature,
		'WHERE'		=> 'g_id='.$group_id
	);
]]></hook>
				
</hooks>
</extension>